{% extends 'login/index.html' %}

{% block title %}{{ title }}{% endblock %}


{% block content %}
<aside >
    <textarea id="all_users"></textarea>
    <!-- <ul>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </ul> -->
</aside>
<div class="chat_class">
    <h1>{{ title }}</h1>
    <nav>
        <form class="logout-link" action="/logout_views" method="post">
            {% csrf_token %}
            <p class="usr">Logged in as : {{ user.username }}</p>
            <button class="btn btn-success" type="submit">Logout</button>

        </form>
    </nav>

    <!-- <form method="post">
        {% csrf_token %}
        {{ form.text_area }}<br>
        <button class="btn btn-warning" type="submit">Send</button><br>
        <span>{{ error }}</span>
    </form> -->
    <div >
        <textarea id="TextArea" name="story"rows="5" cols="33">
            {{ aaa }}
        </textarea>
    </div>

    <br>

    <form id="post-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="username" id="username" value="{{ user.username }}">
        {{ form }} <br>
        <input type="button" id="button" value="Send">
    </form>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // var today = new Date();
        // var dd = String(today.getDate()).padStart(2, '0');
        // var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        // var yyyy = today.getFullYear();

        // today = mm + '/' + dd + '/' + yyyy;
        $(function () {
            $.ajaxSetup({
                headers: {
                    "X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()
                }
            })
        });
        $(document).ready(function () {
            $("#button").click(function () {
                $.post("/public_chat",
                    {
                        username: "{{ user.username }}",
                        text: document.getElementById("id_text_area").value,
                        // SendDate:  document.getElementById("id_msg_date")

                    },
                    function (data, status) {
                        console.log(data)
                        // document.getElementById("message").value = data["mystring"];

                    });
            });
        });

    </script>
    <script language="javascript" type="text/javascript">
        function fetchdata() {
            $.ajax({
                url: '/public_chat_read',
                type: 'post',
                success: function (data) {
                    // console.log(data);
                    var res = "";
                    for (var i = 0; i < data.length; i++){
                        // console.log('aaa')
                        res += data[i].fields.user_name + "   ->   "+ data[i].fields.text_area + "\n";
                        document.getElementById("TextArea").value = res;
                    }
                },
                complete: function (data) {
                    setTimeout(fetchdata, 5000);
                }
            });
        }

        $(document).ready(function () {
            setTimeout(fetchdata, 3000);
        });
    </script>

<script language="javascript" type="text/javascript">
    function fetchdata_1() {
        $.ajax({
            url: '/public_chat_users',
            type: 'post',
            success: function (data_1) {
                console.log(data_1.length);
                
                var res = "";
                for (var i = 0; i < data_1.length; i++){
                    console.log(data_1[i].fields.username)
                    res += data_1[i].fields.username + "\n";
                    document.getElementById("all_users").value = res;
                }
            },
            complete: function (data_1) {
                setTimeout(fetchdata_1, 5000);
            }
        });
    }

    $(document).ready(function () {
        setTimeout(fetchdata_1, 3000);
    });
</script>


</div>
{% endblock %}